<!DOCTYPE html>
<html lang=de>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="icon" type="image/png" href="blink180.png">
	<link rel="apple-touch-icon" sizes="180x180" href="blink180.png">
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#fbfbfb">
	<meta name="Description" content="Blink">
	<title>BLINK</title>
	<script>

		function go() {
			document.getElementById('cam_jpg').onclick=()=>{window.open(document.getElementById('cam_jpg').src,'_self');};
			document.getElementById('cam_image').style.height=document.getElementById('cam_image').clientWidth*0.5625+'px';
			blink_get_homescreen_and_videoevents();
		}

		var global_homescreen_and_videoevents=undefined;
		function display(homescreen_and_videoevents,video_id) {
			global_homescreen_and_videoevents=homescreen_and_videoevents;
			let hv=homescreen_and_videoevents?JSON.parse(homescreen_and_videoevents):undefined;
			let h=hv?hv.homescreen:undefined;
			let v=hv?hv.videoevents:undefined;
			let cjpg=document.getElementById('cam_jpg');
			let cvideo=document.getElementById('cam_video');
			let cname=document.getElementById('cam_name');
			let cdate=document.getElementById('cam_date');
			cname.innerHTML='&nbsp;';
			cdate.innerHTML='&nbsp;';
			
			// set video-thumbnails
			if (v&&v.media) {
				let i=0; while ((i<3)&&(v.media[i])) {
					document.getElementById('vt'+i+'i').src='media/thumbnail/'+v.media[i].id;
					document.getElementById('vt'+i+'c').innerHTML=new Date(v.media[i].created_at).toLocaleTimeString();
					i++;
				}
			}
			
			// VIDEO
			// hack for taking video_id from media-array, if given video_id is within reasonable range (0, 1 or 2 for example)
			// real video_id's usually have larger values
			if (v&&v.media&&video_id!==undefined&&v.media[video_id]) {video_id=v.media[video_id].id};
			// if video_id then display this video
			// filter for this video_id ...
			let video=v.media?v.media.filter(v => v.id==video_id)[0]:undefined;
			if (video) {
				cjpg.style.display='none';
				cvideo.style.display='block';
				cvideo.style.width='100%';
				cvideo.style.height='100%';
				cvideo.src='media/'+video_id;
				//cvideo.preload='none';
				cvideo.autoplay=true;
				cname.innerHTML=video.device_name;
				cdate.innerHTML=new Date(video.created_at).toLocaleString();
			} else {
				// IMAGE
				// else display current thumbnail of first camera
				cvideo.style.display='none';
				cjpg.style.display='block';
				if (h&&h.cameras) {
					cjpg.src='cam.jpg?'+h.cameras[0].updated_at;
					cname.innerHTML=h.cameras[0].name+' | '+Math.round((h.cameras[0].signals.temp-32)*5/9)+'Â°C';
					cdate.innerHTML=new Date(h.cameras[0].updated_at).toLocaleString();
				}
			}
			
			if (h&&h.cameras) {
				let bu=document.getElementById('btn_update');
				bu.className='btn';
				bu.onclick=()=>{blink_update_cam()};
			}

			if (h&&!h.account&&confirm('Do you want to log in?')) {blink_login(true)};
		}

		function blink_login(just_use_the_credentials_known_by_the_server_to_log_in_again_and_get_a_new_authtoken) {
			if (just_use_the_credentials_known_by_the_server_to_log_in_again_and_get_a_new_authtoken) {
				get('api','{"command":"login"}',(r)=>{
					log(r);
					let rj=JSON.parse(r);
					if (rj&&rj.client&&rj.client.verification_required&&rj.client.id) {blink_verify()} else {
						if (!rj.error) {blink_update()} else {blink_login(false)}
					}
				});
			} else {
				let email=prompt('Enter your email to connect this server to Blink.','')
				if (email) {
					let pw=prompt('Ok, '+email+'.\nNow enter your password.','')
					if (pw) {
						get('api','{"command":"login","email":"'+email+'","password":"'+pw+'"}',(r)=>{
							log(r);
							let rj=JSON.parse(r);
							if (rj&&rj.client&&rj.client.verification_required&&rj.client.id) {blink_verify()} else {blink_update()}
						});
					};
				};		
			};
		}
		function blink_verify() {
			let pin=prompt('Blink requests verification.\nPlease check your email for the required PIN.','');
			if (pin) {
				get('api','{"command":"verify","pin":"'+pin+'"}',(r)=>{
					log(r);
					blink_update();
				});
			};
		}
		function blink_logout() {
			if (confirm('This will disconnect this server from Blink.\nDo you really want to do this?')) {
				get('api','{"command":"logout"}',(r)=>{
					log(r);
					blink_update();
				});
			};
		}
		function blink_update_cam() {
			let bu=document.getElementById('btn_update');
			bu.blur();
			bu.className='btn_disabled';
			bu.onclick=undefined;				
			get('api','{"command":"update_cam"}',(r)=>{
				log(r);
				log('waiting for 5 seconds...');
				setTimeout(()=>{blink_update();},5000)
			});
		}
		function blink_update() {
			get('api','{"command":"update"}',(r)=>{
				log(r);
				display(r);
			});
		}
		function blink_get_homescreen_and_videoevents() {get('api','{"command":"get_homescreen_and_videoevents"}',(r)=>{log(r);display(r)})}
		function blink_get_log() {get('api','{"command":"get_log"}',(r)=>{log(r)})}

		function get(file,json_request,callback) {callAPI('POST',window.location.href.replace(/[^/]*$/,'')+file,json_request,(r)=>{callback(r)})}
		function callAPI(method,URI,reqobj,callback) {
			if (!(URI).startsWith('http')) {log('fetching '+URI+' aborted');callback();return true;}
			var t=stopwatch();
			var req = new XMLHttpRequest();
			req.onreadystatechange = function() {if (this.readyState == 4) {
				log(method+' '+URI+': '+stopwatch(t)+'ms'); 
				if (this.status<500) {callback(this.responseText)} else {callback()}}
			};
			req.open(method,URI,true);
			req.setRequestHeader("Content-Type","application/json;charset=UTF-8");
			req.send(reqobj);
		}
		function stopwatch(time) {if (typeof time != 'undefined') {return new Date()-time} else {return new Date()}}
		function IsJsonString(str) {let json=undefined; try {json=JSON.parse(str)} catch (e) {return false}; return json[0]?true:false}

		function log(l) {console.log(l)};

	</script>
	<style>
		* {box-sizing: border-box;}
		html, body, section, div, input, textarea, select, button {border-radius: 0.3rem;font-family: Verdana, Geneva, sans-serif; font-size: 1.3rem; width:100%; overflow-wrap:break-word;}
		body {border:0; padding:0%; margin:0; background-color:#fbfbfb; color: #000;}

		.bigscreen {padding:0rem 1rem 1rem 1rem; margin:0;}
		.screen {min-width:300px; max-width:420px; margin:auto; text-align:center;}

		@media only screen and (max-width: 320px) {
			.bigscreen {padding:0rem 0.6rem 1rem 0.6rem;}
			.screen {min-width:260px;}
			html, body, section, div, input, textarea, select, button {font-size: 1rem}
		}
		@media only screen and (min-width: 768px) {
			.screen {min-width:640px; max-width:640px; margin:auto;}
			html, body, section, div, input, textarea, select, button {font-size: 1.5rem}
		}

		@media print {
			.screen {max-width:100%; margin:auto;}
			body {background-color:#FFFFFF;}
		}

		#header {margin:1.4rem 0 1rem 0;}
		#cam_image {display:inline-block; background-color:#f0f0f0; overflow:hidden;} /*1280*720*/
		#cam_image img {display:block; width:100%; cursor:pointer;}
		#cam_jpg {transition:0.2s}
		/*#cam_jpg:hover {transform:scale(1.05)}*/
		#cam_video {display:none}
		.cam_info {font-size:1rem;text-align:right;border-bottom:0px solid #e0e0e0;border-radius:0;margin:0rem 0 0.2rem 0;padding:0rem 0.2rem;}
		#cam_videothumbnails_bar {display:flex;justify-content:space-between;padding:1rem 0 1rem 0;}
		.videothumbnail_container {position:relative;overflow:hidden;width:30%;background-color:#e0e0e0;}
		.videothumbnail, .videothumbnail_image, .videothumbnail_overlay {transition:0.1s;position:relative;width:100%;height:100%;}
		.videothumbnail_caption {opacity:0.8;position:absolute;bottom:0.2rem;right:0.2rem;font-size:0.6rem;color:#fff;background-color:#000;width:auto;padding:0 0.3rem;border-radius:0;}
		.videothumbnail_overlay {opacity:0.4;position:absolute;top:0;left:0;cursor:pointer;background-repeat:no-repeat;background-size:30%;background-position:center;background-image:url('video_play.svg');}
		.videothumbnail_overlay:hover {transform:scale(1.1)}

		a {color:#000; _text-decoration:none;}
		a:hover {color:#0078D4;}
		.btn {border: 2px solid #0078D4;background-color:#0078D4;color:#FFF;cursor:pointer;padding:0.2rem 0rem;margin:0.2rem 0 0.2rem 0;}
		/*.btn:hover {background-color:#0068C4;}*/
		.btn_disabled {border: 2px solid #E0E0E0;background-color:#E0E0E0;color:#A0A0A0;padding:0.2rem 0rem;margin:0.2rem 0 0.2rem 0;}

	</style>
</head>
<body onload='go()'>
	<div id=bigscreen class=bigscreen>
		<div id=screen class=screen>
			<div id=header></div>
			<div id=cam_image><img id=cam_jpg><video id=cam_video controls></video></div>
			<div id=cam_name class=cam_info></div>
			<div id=cam_date class=cam_info></div>
			<button id=btn_update class=btn_disabled onclick=blink_update_cam()>update</button>
			<div id=cam_videothumbnails_bar>
				<div class=videothumbnail_container>
					<div class=videothumbnail><img id=vt0i class=videothumbnail_image></div><div id=vt0c class=videothumbnail_caption></div><div onclick=display(global_homescreen_and_videoevents,0); class=videothumbnail_overlay></div>
				</div>
				<div class=videothumbnail_container>
					<div class=videothumbnail><img id=vt1i class=videothumbnail_image></div><div id=vt1c class=videothumbnail_caption></div><div onclick=display(global_homescreen_and_videoevents,1); class=videothumbnail_overlay></div>
				</div>
				<div class=videothumbnail_container>
					<div class=videothumbnail><img id=vt2i class=videothumbnail_image></div><div id=vt2c class=videothumbnail_caption></div><div onclick=display(global_homescreen_and_videoevents,2); class=videothumbnail_overlay></div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
